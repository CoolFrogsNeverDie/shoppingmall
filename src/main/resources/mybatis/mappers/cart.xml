<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<!-- 이 공간에 있는 쿼리문들을 호출할 때 이름의 시작 -->

<mapper namespace="cart">

	<!-- 장바구니 체크 -->
	<select id="checkCart" resultType="CartVO"
		parameterType="CartVO">
		<![CDATA[
			select 
				cart_no as cartNo
			from cart
			where customer_no = #{customerNo}
		]]>
	</select>

	<!-- 장바구니 추가 -->
	<insert parameterType="CartVO" id="insertCart">
		<selectKey resultType="int" order="BEFORE" keyProperty="cartNo">
			select seq_cart_no.nextval from dual 
		</selectKey>
			<![CDATA[
				insert into cart 
					(cart_no
					,customer_no)
						values (
						#{cartNo},
						#{customerNo}
								)
			]]>
	</insert>


	<!-- 장바구니 상세정보 추가 -->
	<insert parameterType="CartVO" id="insertCartDetail">
		<![CDATA[
			insert into cart_detail
			(cart_detail_no, cart_no, product_no, product_count)
			values(
				seq_cart_detail_no.nextval
				,#{cartNo}
				,#{productNo}
				,#{productCnt}
				)
		]]>
	</insert>


	<!-- 장바구니 리스트 가져오기 -->
	<select id="getCartList" parameterType="int" resultType="ProductVO">
		<![CDATA[
			SELECT
				d.product_no as productNo
				,d.product_name as productName
				,SUM(a.product_count) as productEa
				,d.price as price
				,e.save_name as saveName
				,MAX(a.cart_detail_no) AS ordernum
			FROM cart_detail a
			JOIN cart c ON c.cart_no = a.cart_no
			JOIN product d ON d.product_no = a.product_no
			JOIN product_image e ON e.product_no = d.product_no
			WHERE c.customer_no = #{customerNo}
			GROUP BY d.product_no, d.product_name, c.customer_no, d.price, e.save_name
			ORDER BY ordernum DESC
		]]>
	</select>


	<!-- 장바구니 상세 내역 삭제 -->
	<delete id="deleteList" parameterType="CartVO">
		<![CDATA[
			delete cart_detail 
			where cart_no = #{cartNo} 
			and product_no = #{productNo}
		]]>
	</delete>

	<!-- 주문 존재여부 확인 -->
	<select id="checkOrder" parameterType="String" resultType="OrderVO">
		<![CDATA[
			select 
				order_no as orderNo
				,total_price as totalPrice
			from orders 
			where customer_no = #{customerNo}  and order_stat = 1
		]]>
	</select>

	<!-- 주문 추가 -->
	<insert id="insertOrder" parameterType="OrderVO">
		<selectKey resultType="int" order="BEFORE"
			keyProperty="orderNo">
			select SEQ_ORDER_NO.nextval from dual
		</selectKey>
			<![CDATA[
				insert into orders (ORDER_NO, CUSTOMER_NO, ORDER_STAT)
				values (
						#{orderNo}
						,#{customerNo}
						,1
						)
			]]>
	</insert>

	<!-- 주문 상세내역 추가 -->
	<insert id="insertOrderDetail" parameterType="map">
		<![CDATA[
   	     insert into order_detail 
    	    	(detail_no, order_no, product_no, product_count)
    	    values (
    	    		SEQ_DETAIL_NO.nextval
       		 		, #{orderNo}
        			, #{orderProduct.productNo}
        			,#{orderProduct.productEa}
        			)
		]]>
	</insert>

	<!-- 주문 삭제 -->
	<delete id="deleteOrder" parameterType="int">
		<![CDATA[
			delete orders
			where order_no = #{orderNo}
		]]>
	</delete>

	<!-- 주문 상세내역 삭제 -->
	<delete id="deleteOrderDetail" parameterType="int">
		<![CDATA[
			delete order_detail
			where order_no = #{orderNo}
		]]>
	</delete>

	<!-- 주문 상세내역 가져오기 -->
	<select id="getOrderDetail" parameterType="OrderVO" resultType="ProductVO">
		<![CDATA[
			SELECT
   				 a.product_no as productNo
   				 ,a.product_count as productEa
   				 ,b.price
    			 ,b.product_name as productName
  				 ,c.save_name as saveName
			FROM
    		order_detail a join product b
    		on a.product_no = b.product_no
    		join product_image c on b.product_no  = c.product_no
    		where a.order_no = #{orderNo}
		]]>
	</select>

	<update id ="checkOrderDetailList" parameterType ="OrderVO">
		update order_detail a set 
			product_count = (select product_ea from product where product_no = a.product_no)
		where a.order_no = #{orderNo}
		and a.product_count > (select product_ea from product where a.product_no = product_no) 
	</update>
	
	
	<!-- 주소 리스트 가져오기 -->
	<select id="getAddressList" parameterType="String" resultType="AddressVO">
		<![CDATA[
			select	
				tell as tel
				,reci_name as name
				,post_num as postNum
				,address
				,address_detail as addressDetail
				,email
			from address
			where customer_no = #{customerNo}
		]]>
	</select>


	<!-- 등록된 주소 리스트 수량 체크 -->
	<select id="AddressCnt" parameterType="AddressVO" resultType="int">
		<![CDATA[
			 select
    	     	count(*)
    	     from address
    	     where customer_no = #{customerNo}
		]]>
	</select>

	<!-- 주소 삭제 -->
	<delete id="deleteAddress" parameterType="AddressVO">
  		<![CDATA[
  		    delete address
        	   where address_no  =
            	  (select
            	      min(address_no)
            	   from address
            	   where customer_no = #{customerNo})
   		]]>
	</delete>

	<!-- 주소 추가 -->
	<insert id="insertAddress" parameterType="AddressVO">
  		 <![CDATA[
  		    insert into address
    		     (address_no, customer_no, address,tell, post_num, address_detail, reci_name, email)
    			  values(
        			    seq_address_no.nextval
       				    ,#{customerNo}
      			        ,#{address}
      			      	,#{tel}
			            ,#{postNum}
        			    ,#{addressDetail}
           			    ,#{name}
      			        ,#{email}
 			           )
 		  ]]>
	</insert>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<!-- 이 공간에 있는 쿼리문들을 호출할 때 이름의 시작 -->

<mapper namespace="cart">


<select id="checkCart" resultType="CartVO" parameterType="CartVO" >

	<![CDATA[
		select 
			cart_no as cartNo
		from cart
		where customer_no = #{customerNo}
	]]>
</select>


<insert parameterType="CartVO" id="insertCart">

<selectKey resultType="int" order="BEFORE" keyProperty="cartNo">select seq_cart_no.nextval from dual </selectKey>

	<![CDATA[
			insert into cart 
			(cart_no
			,customer_no)
				values (
					#{cartNo},
					#{customerNo}
						)
		]]>
</insert>


<insert parameterType="CartVO" id="insertCartDetail">

	<![CDATA[
		insert into cart_detail
		(cart_detail_no, cart_no, product_no, product_count)
		values(
			seq_cart_detail_no.nextval
			,#{cartNo}
			,#{productNo}
			,#{productCnt}
			)
	]]>
</insert>


<select id ="getCartList" parameterType ="int" resultType = "ProductVO">
	<![CDATA[
		SELECT
			d.product_no as productNo
			,d.product_name as productName
			,SUM(a.product_count) as productEa
			,d.price as price
			,e.save_name as saveName
			,MAX(a.cart_detail_no) AS ordernum
		FROM cart_detail a
		JOIN cart c ON c.cart_no = a.cart_no
		JOIN product d ON d.product_no = a.product_no
		JOIN product_image e ON e.product_no = d.product_no
		WHERE c.customer_no = #{customerNo}
		GROUP BY d.product_no, d.product_name, c.customer_no, d.price, e.save_name
		ORDER BY ordernum DESC
	]]>
</select>


<delete id ="deleteList" parameterType ="CartVO">
	<![CDATA[
		delete cart_detail 
		where cart_no = #{cartNo} 
		and product_no = #{productNo}
	]]>
</delete>

<select id ="checkOrder" parameterType ="String" resultType = "OrderVO">
	<![CDATA[
		select 
			order_no as orderNo
			,total_price as totalPrice
		from orders 
		where customer_no = #{customerNo}  and order_stat = 1
	]]>
</select>

<insert id ="insertOrder" parameterType ="OrderVO">
	<selectKey resultType="int" order="BEFORE" keyProperty="orderNo">
		select SEQ_ORDER_NO.nextval from dual 
	</selectKey>
	<![CDATA[
		insert into orders (ORDER_NO, CUSTOMER_NO, ORDER_STAT, total_price)
		values (#{orderNo},#{customerNo},1, #{totalPrice})
	]]>
</insert>

<insert id = "insertOrderDetail" parameterType ="map">
	<![CDATA[
        insert into order_detail 
        	(detail_no, order_no, product_no, product_count)
        values (
        		SEQ_DETAIL_NO.nextval
        		, #{orderNo}
        		, #{orderProduct.productNo}
        		,#{orderProduct.productEa}
        		)
	]]>
</insert>

<delete id ="deleteOrder" parameterType ="int">
	<![CDATA[
		delete orders
		where order_no = #{orderNo}
	]]>
</delete>

<delete id ="deleteOrderDetail" parameterType ="int">
	<![CDATA[
		delete order_detail
		where order_no = #{orderNo}
	]]>
</delete>

<select id = "getOrderDetail" parameterType ="OrderVO" resultType ="ProductVO">
	<![CDATA[
		SELECT
   			 a.product_no as productNo
   			 ,a.product_count as productEa
   			 ,b.price * a.product_count  as  price
    		 ,b.product_name as productName
  			 ,c.save_name as saveName
		FROM
    	order_detail a join product b
    	on a.product_no = b.product_no
    	join product_image c on b.product_no  = c.product_no
    	where a.order_no = #{orderNo}
	]]>
</select>

</mapper>
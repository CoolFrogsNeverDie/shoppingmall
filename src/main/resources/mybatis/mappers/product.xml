<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 이 공간에 있는 쿼리문들을 호출할 때 이름의 시작 -->
<mapper namespace="product">

	<!-- 상품등록 -->
	<insert id="insertProduct" parameterType="ProductVO">

		<selectKey keyProperty="productNo" resultType="int"
			order="BEFORE">
			SELECT seq_product_no.nextval AS productNo FROM dual
		</selectKey>
		
		<![CDATA[
			
			insert into product(
	                    PRODUCT_NO,
	                    PRODUCT_NAME,
	                    PRODUCT_EA,
	                    PRICE,
	                    PRODUCT_CONTENT,
	                    REG_DATE,
	                    CATEGORY,
	                    SUBCATEGORY
	                    )
	            values(
	                    #{productNo},
	                    #{productName},
	                    #{productEa},
	                    #{price},
	                    #{productContent},
	                    sysdate,
	                    #{category},
	                    #{subCategory}	            
	                    )
	

		]]>

	</insert>

	<!-- 상품삭제 -->
	<delete id="deleteProduct" parameterType="int">
		
		<![CDATA[
		
			delete from product where product_no = #{productNo}
		
		]]>

	</delete>

	<!-- 상품수 가져오기 -->
	<select id="getTotal" parameterType="Criteria" resultType="int">
	
		<![CDATA[
		
			SELECT
			      COUNT(*)
			  FROM
			      product
			 WHERE
			      1 = 1
		]]>

		<if test="category != 'all'">
			AND category = '${category}'
		</if>
		<!-- <if test="subCategory != 'all' and subCategory == null"> AND subcategory 
			= '${subCategory}' </if> -->

	</select>

	<!-- 상품수 가져오기 -->
	<select id="getTotalSubCategory" parameterType="Criteria"
		resultType="int">
	
		<![CDATA[
		
			SELECT
			      COUNT(*)
			  FROM
			      product
			 WHERE
			      1 = 1
		]]>

		<if test="category != 'all'">
			AND category = '${category}'
		</if>
		<![CDATA[
			AND subcategory	= '${subCategory}'
		]]>

	</select>

	<!-- 상품리스트 가져오기 -->
	<select id="getAllProductList" resultType="ProductVO">
	
		<![CDATA[
		
			SELECT
			      a.product_no as productNo,
			      product_name as productName,
			      product_ea as productEa,
			      price,
			      product_content as productContent,
			      reg_date as regDate,
			      category,
			      subcategory as subCategory,
			      b.save_name as saveName,
			      b.image_no as imageNo
			  FROM
			      product a
			      INNER JOIN product_image b 
			      ON a.product_no = b.product_no
		  ORDER BY
			      a.product_no DESC
		
		]]>

	</select>

	<!-- 상품리스트 가져오기 테스트 -->
	<select id="getAllProductListTest" parameterType="Criteria"
		resultType="ProductVO">
	
		<![CDATA[
		
  select        d.product_no as productNo,
                d.product_name as productName,
                d.product_ea as productEa,
                d.price,
                d.product_content as productContent,
                d.reg_date as regDate,
                d.category,
                d.subcategory as subCategory,
                d.save_name as saveName,
                d.image_no as imageNo   
      from(select  
                rownum as rn,
                c.product_no, 
                c.product_name,
                c.product_ea,
                c.price,
                c.product_content,
                c.reg_date,
                c.category,
                c.subcategory ,
                c.save_name ,
                c.image_no
            from (SELECT
                        a.product_no, 
                        a.product_name,
                        a.product_ea,
                        a.price,
                        a.product_content,
                        a.reg_date,
                        a.category,
                        a.subcategory ,
                        b.save_name ,
                        b.image_no 
                    FROM
                        product a inner join product_image b 
                      ON 
                        a.product_no = b.product_no
                   WHERE
                   		1 = 1
        ]]>

		<if test="category != 'all'">
			AND category = '${category}'
		</if>
	        		
        <![CDATA[                                        
                        order by a.product_no desc) c
                        ) d
            where d.rn > (#{pageNum}-1) * #{amount}
            and d.rn <= #{pageNum} * #{amount}
			
		]]>

	</select>

	<!-- 카테고리 상품 리스트 가져오기 -->
	<select id="getCategoryProductListTest" parameterType="ProductVO"
		resultType="ProductVO">
	
		<![CDATA[
		
			 select        d.product_no as productNo,
                d.product_name as productName,
                d.product_ea as productEa,
                d.price,
                d.product_content as productContent,
                d.reg_date as regDate,
                d.category,
                d.subcategory as subCategory,
                d.save_name as saveName,
                d.image_no as imageNo   
      from(select  
                rownum as rn,
                c.product_no, 
                c.product_name,
                c.product_ea,
                c.price,
                c.product_content,
                c.reg_date,
                c.category,
                c.subcategory ,
                c.save_name ,
                c.image_no
            from (SELECT
                        a.product_no, 
                        a.product_name,
                        a.product_ea,
                        a.price,
                        a.product_content,
                        a.reg_date,
                        a.category,
                        a.subcategory ,
                        b.save_name ,
                        b.image_no 
                    FROM
                        product a inner join product_image b 
                      ON 
                        a.product_no = b.product_no
                   WHERE
                   		1 = 1
         ]]>

		<if test="category != 'all'">
			AND a.category = '${category}'
		</if>
		                
         <![CDATA[ 
        	 AND a.subcategory = '${subCategory}'  
			 order by a.product_no desc) c
                        ) d
            where d.rn > (#{pageNum}-1) * #{amount}
            and d.rn <= #{pageNum} * #{amount}
			
		]]>

	</select>


	<!-- 카테고리 상품 리스트 가져오기 -->
	<select id="getCategoryProductList" parameterType="ProductVO"
		resultType="ProductVO">
	
		<![CDATA[
		
			SELECT
			      a.product_no as productNo,
			      product_name as productName,
			      product_ea as productEa,
			      price,
			      product_content as productContent,
			      reg_date as regDate,
			      category,
			      subcategory as subCategory,
			      b.save_name as saveName,
			      b.image_no as imageNo
			  FROM
			      product a,
			      product_image b 
             WHERE 
            	  a.product_no = b.product_no
         ]]>

		<if test="category != 'all'">
			AND a.category = '${category}'
		</if>
		<if test="subCategory != 'all' ">
			AND a.subcategory = '${subCategory}'
		</if>
                
         <![CDATA[        
			 ORDER BY
			      a.product_no DESC
			
		]]>

	</select>

	<!-- 상품 검색 -->
	<select id="productSearch" parameterType="String"
		resultType="ProductVO">
	
		<![CDATA[
		
			SELECT
			      a.product_no as productNo,
			      product_name as productName,
			      product_ea as productEa,
			      price,
			      product_content as productContent,
			      reg_date as regDate,
			      category,
			      subcategory as subCategory,
			      b.save_name as saveName,
			      b.image_no as imageNo
			  FROM
			      product a
			      INNER JOIN product_image b 
			      ON a.product_no = b.product_no
			      WHERE product_name like '%'||#{keyword}||'%'
		  ORDER BY
			      a.product_no DESC
		
		]]>


	</select>


	<!-- 상품 정보 가져오기 -->
	<select id="getProduct" parameterType="ProductVO"
		resultType="ProductVO">
	
		<![CDATA[
		
			SELECT
			      a.product_no as productNo,
			      product_name as productName,
			      product_ea as productEa,
			      price,
			      product_content as productContent,
			      reg_date as regDate,
			      category,
			      subcategory as subCategory,
			      b.save_name as saveName,
			      b.image_no as imageNo
			  FROM
			      product a
			      INNER JOIN product_image b 
			      ON a.product_no = b.product_no
			  where
			      a.product_no = #{productNo}

		]]>

	</select>

	<!-- 상품 정보 수정 -->
	<update id="modifyProduct" parameterType="ProductVO">
		
		<![CDATA[
		
			update product 
					   set                  
		                  product_name = #{productName},
		                  product_ea = #{productEa},
		                  price = #{price},
		                  product_content = #{productContent},
		                  category = #{category},
		                  subcategory = #{subCategory}
		        	where product_no = #{productNo}
	
		]]>


	</update>


</mapper>






